# Text to SQL API (V2) 文档

Text to SQL API 用于将用户输入的文本转换为 SQL 查询语句，并返回查询结果。

| 路径 | 请求方式 | 说明 |
| --- | --- | --- |
| /agent/api/v1/docs | GET | 获取openapi文档 |
| /agent/api/v1/openapi.json | GET | 获取openapi文档(纯文本,Json格式) |
| /agent/api/v1/status | GET | 获取agent状态 |
| /agent/api/v1/text2sql | POST | Text2SQL Conversion |

## `/agent/api/v1/docs` 获取openapi文档

文档静态页面，不需要鉴权。

## `/agent/api/v1/openapi.json` 获取openapi文档

### 返回值

返回openapi文档

**示例**

```json
{
  "openapi": "3.0.0",
  "info": {
    "version": "1.0.0",
    "title": "Hubble AI Text2SQL API",
    "description": "\n# Hubble AI Text2SQL API\n\nAn intelligent Text2SQL conversion service based on LangGraph, supporting real-time conversion from natural language to SQL queries.\n\n\n    "
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "Development"
    }
  ],
  "components": {
    "schemas": {

    },
    "parameters": {

    }
  },
  "paths": {
    "/status": {
      "get": {
        "summary": "Health Check",
        "description": "Checks if the service is running correctly.",
        "tags": [
          "System"
        ],
        "responses": {
          "200": {
            "description": "Service is running normally.",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": {
                      "type": "string",
                      "description": "Service status"
                    },
                    "message": {
                      "type": "string",
                      "description": "Status message"
                    },
                    "timestamp": {
                      "type": "string",
                      "description": "Timestamp of the response"
                    }
                  },
                  "required": [
                    "status",
                    "message",
                    "timestamp"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/api/text2sql": {
      "post": {
        "summary": "Text2SQL Conversion",
        "description": "\nConverts a natural language query into an SQL query and executes it. Supports Server-Sent Events (SSE) for streaming responses.\n\n### Streaming Event Types:\n- **workflow_start**: The workflow has started.\n- **node_execution**: A node in the graph is being executed.\n- **plan_created**: The execution plan has been created.\n- **step_completed**: A step in the plan has been completed.\n- **token**: A real-time token generated by the LLM.\n- **result**: The final result of the execution.\n- **complete**: The process has finished.\n- **error**: An error occurred.\n\n### Usage Example:\n```javascript\nconst eventSource = new EventSource('/api/text2sql', {\n  method: 'POST',\n  body: JSON.stringify({ query: 'Show me the top 10 token trades by volume today' })\n});\n\neventSource.onmessage = function(event) {\n  const data = JSON.parse(event.data);\n  console.log('Event Type:', data.type, 'Data:', data);\n};\n```\n  ",
        "tags": [
          "Text2SQL"
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "query": {
                    "type": "string",
                    "minLength": 1,
                    "description": "The user's natural language query"
                  }
                },
                "required": [
                  "query"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Streams real-time events from the Text2SQL process.",
            "content": {
              "text/event-stream": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "type": "object",
                      "properties": {
                        "type": {
                          "type": "string",
                          "enum": [
                            "workflow_start",
                            "node_execution",
                            "plan_created",
                            "step_completed",
                            "node_error",
                            "workflow_complete",
                            "token",
                            "result",
                            "complete",
                            "error"
                          ],
                          "description": "The type of the event"
                        },
                        "data": {
                          "nullable": true,
                          "description": "The event data"
                        },
                        "timestamp": {
                          "type": "string",
                          "description": "Timestamp of the event"
                        },
                        "message": {
                          "type": "string",
                          "description": "Message associated with the event"
                        }
                      },
                      "required": [
                        "type",
                        "timestamp"
                      ],
                      "description": "SSE event data"
                    }
                  },
                  "required": [
                    "data"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Invalid request parameters.",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error message"
                    },
                    "timestamp": {
                      "type": "string",
                      "description": "Timestamp of the error"
                    }
                  },
                  "required": [
                    "error",
                    "timestamp"
                  ]
                }
              }
            }
          },
          "500": {
            "description": "Internal server error.",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "description": "Error message"
                    },
                    "timestamp": {
                      "type": "string",
                      "description": "Timestamp of the error"
                    }
                  },
                  "required": [
                    "error",
                    "timestamp"
                  ]
                }
              }
            }
          }
        }
      }
    }
  }
}
```

## `/agent/api/v1/status` 获取agent状态

### 参数
无

### 返回值

返回json格式的数据，包含以下字段
- `status`: 状态，ok表示成功
- `message`: 消息
- `timestamp`: 时间戳

**示例**

```json
{
  "status": "ok",
  "message": "Server is running",
  "timestamp": "2025-07-03T09:33:32.485Z"
}
```

## `/agent/api/v1/text2sql` Text2SQL 请求

将自然语言查询转换为SQL查询并执行。支持使用Server-Sent Events (SSE)进行流式响应。

流式事件类型：
workflow_start: 工作流已启动。
node_execution: 图中的节点正在执行。
plan_created: 执行计划已创建。
step_completed: 计划中的步骤已完成。
token: LLM生成的实时令牌。
result: 执行的最终结果。
complete: 处理已完成。
error: 发生错误。

Converts a natural language query into an SQL query and executes it. Supports Server-Sent Events (SSE) for streaming responses.

Streaming Event Types:
workflow_start: The workflow has started.
node_execution: A node in the graph is being executed.
plan_created: The execution plan has been created.
step_completed: A step in the plan has been completed.
token: A real-time token generated by the LLM.
result: The final result of the execution.
complete: The process has finished.
error: An error occurred.

### 参数

- `query`: 自然语言查询
- `stream`: 是否流式返回，布尔值，默认为 true。true 时返回流式 SSE 事件，false 时只返回最终的 json 对象。

### 返回值

- 当 `stream` 为 `true`（默认）：返回 Server-Sent Events (SSE) 流式数据，每一行以 `data:` 开头，内容为 JSON 对象，包含事件类型、数据、时间戳等。例如：

```text
// SSE流式返回示例

data: {"type":"workflow_start","message":"Starting Text2SQL agent","query":"...","timestamp":"..."}
data: {"type":"llm_start",...}
data: {"type":"token",...}
data: {"type":"result","data":[{"trader_wallet_address":"7G5z8owm8WGcwLDfYEXEbgd3VsRoJ5XU5JjXCiuC55SR","profit_loss":39.44}, ...],"totalSteps":4,"rowCount":50,"timestamp":"..."}
data: {"type":"complete","message":"Query processing completed in 4 steps","timestamp":"..."}
```

- 当 `stream` 为 `false`：直接返回最终结果的 JSON 对象。例如：

```json
{
  "data": [
    {"trader_wallet_address": "7G5z8owm8WGcwLDfYEXEbgd3VsRoJ5XU5JjXCiuC55SR", "total_profit_loss": 39.08932488699998},
    {"trader_wallet_address": "8hjfBLZ6kA5MiMYPaCT6R5KAe1XtgARPLnCwnpiS9wg9", "total_profit_loss": 34.775627572},
    ...
  ],
  "timestamp": "2025-07-07T09:16:14.088Z"
}
```

**示例**

- [1. 请求交易量前10的Token](examples/1.get_top10_tokens/README.md)
